!function(){function e(e,t,a){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var r=a.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}System.register(["./index-legacy-DVVyv3Gx.js"],function(t,a){"use strict";var r,n,l,o,s,i,u,c,d,m,g,E,y,h,p,v,f;return{setters:[e=>{r=e.aA,n=e.aB,l=e.aC,o=e.aD,s=e.aE,i=e.aF,u=e.aG,c=e.aH,d=e.aI,m=e.aJ,g=e.aK,E=e.aL,y=e.aM,h=e.aN,p=e.aO,v=e.H,f=e.V}],execute:function(){t("t",{NID_DE_POULE:"Nid de poule",FISSURE:"Fissure",INONDATION:"Inondation",OBSTACLE:"Obstacle",ECLAIRAGE:"Éclairage",SIGNALISATION:"Signalisation",AUTRE:"Autre"}),t("a",{NOUVEAU:"Nouveau",EN_COURS:"En cours",RESOLU:"Résolu",REJETE:"Rejeté"}),t("p",{BASSE:"Basse",NORMALE:"Normale",HAUTE:"Haute",URGENTE:"Urgente"}),t("s",{NOUVEAU:"primary",EN_COURS:"warning",RESOLU:"success",REJETE:"danger"});function a(e,t){return{id:e,titre:t.titre||"",description:t.description||"",typeProbleme:t.typeProbleme||"AUTRE",latitude:t.latitude||0,longitude:t.longitude||0,adresse:t.adresse||"",photoUrl:t.photoUrl,statut:t.statut||"NOUVEAU",priorite:t.priorite||"NORMALE",dateSignalement:t.dateSignalement instanceof h?t.dateSignalement.toDate():new Date(t.dateSignalement||Date.now()),dateResolution:t.dateResolution instanceof h?t.dateResolution.toDate():t.dateResolution?new Date(t.dateResolution):void 0,commentaireResolution:t.commentaireResolution,createdById:t.createdById||"",createdByName:t.createdByName||"",createdByEmail:t.createdByEmail||"",createdAt:t.createdAt instanceof h?t.createdAt.toDate():new Date(t.createdAt||Date.now()),updatedAt:t.updatedAt instanceof h?t.updatedAt.toDate():new Date(t.updatedAt||Date.now())}}const w=new class{constructor(){e(this,"collectionName","signalements")}async getAll(){try{const e=r(n(l,this.collectionName),o("dateSignalement","desc"));return(await s(e)).docs.map(e=>a(e.id,e.data()))}catch(e){throw console.error("Erreur getAll signalements:",e),e}}async getMesSignalements(){const e=i.getCurrentUserId();if(!e)throw new Error("Utilisateur non connecté");try{const t=r(n(l,this.collectionName),u("createdById","==",e),o("dateSignalement","desc"));return(await s(t)).docs.map(e=>a(e.id,e.data()))}catch(t){throw console.error("Erreur getMesSignalements:",t),t}}async getById(e){try{const t=c(l,this.collectionName,e),r=await d(t);return r.exists()?a(r.id,r.data()):null}catch(t){throw console.error("Erreur getById:",t),t}}async create(e){const t=i.getCurrentUser();if(!t)throw new Error("Utilisateur non connecté");try{const a={titre:e.titre,description:e.description||"",typeProbleme:e.typeProbleme,latitude:e.latitude,longitude:e.longitude,adresse:e.adresse||"",photoUrl:e.photoUrl||null,statut:"NOUVEAU",priorite:e.priorite||"NORMALE",dateSignalement:m(),createdById:t.id,createdByName:t.fullName,createdByEmail:t.email,createdAt:m(),updatedAt:m()};return{id:(await g(n(l,this.collectionName),a)).id,titre:e.titre,description:e.description||"",typeProbleme:e.typeProbleme,latitude:e.latitude,longitude:e.longitude,adresse:e.adresse||"",photoUrl:e.photoUrl,statut:"NOUVEAU",priorite:e.priorite||"NORMALE",dateSignalement:new Date,createdById:t.id,createdByName:t.fullName,createdByEmail:t.email,createdAt:new Date,updatedAt:new Date}}catch(a){throw console.error("Erreur create signalement:",a),a}}async delete(e){const t=i.getCurrentUserId();if(!t)throw new Error("Utilisateur non connecté");try{const a=await this.getById(e);if(!a)throw new Error("Signalement non trouvé");if(a.createdById!==t)throw new Error("Vous ne pouvez supprimer que vos propres signalements");await E(c(l,this.collectionName,e))}catch(a){throw console.error("Erreur delete signalement:",a),a}}async update(e,t){try{const a=c(l,this.collectionName,e);await y(a,{...t,updatedAt:m()})}catch(a){throw console.error("Erreur update signalement:",a),a}}async getRecap(){try{const e=await this.getAll(),t=e.length,a=e.filter(e=>"NOUVEAU"===e.statut).length,r=e.filter(e=>"EN_COURS"===e.statut).length,n=e.filter(e=>"RESOLU"===e.statut).length;return{total:t,nouveaux:a,enCours:r,resolus:n,pourcentageResolus:t>0?Math.round(n/t*100):0}}catch(e){throw console.error("Erreur getRecap:",e),e}}};t("u",p("signalement",()=>{const e=v([]),t=v([]),a=v(null),r=v(null),n=v(!1),l=v(null),o=f(()=>e.value.length),s=f(()=>t.value.length),i=f(()=>{const t={NOUVEAU:[],EN_COURS:[],RESOLU:[],REJETE:[]};return e.value.forEach(e=>{t[e.statut]&&t[e.statut].push(e)}),t});return{signalements:e,mesSignalements:t,selectedSignalement:a,recap:r,isLoading:n,error:l,signalementCount:o,mesSignalementsCount:s,signalementsByStatut:i,fetchAll:async()=>{n.value=!0,l.value=null;try{e.value=await w.getAll()}catch(t){l.value=t.message||"Erreur lors du chargement des signalements",console.error("Erreur fetchAll:",t)}finally{n.value=!1}},fetchMesSignalements:async()=>{n.value=!0,l.value=null;try{t.value=await w.getMesSignalements()}catch(e){l.value=e.message||"Erreur lors du chargement de vos signalements",console.error("Erreur fetchMesSignalements:",e)}finally{n.value=!1}},fetchById:async e=>{n.value=!0,l.value=null;try{return a.value=await w.getById(e),a.value}catch(t){return l.value=t.message||"Signalement non trouvé",console.error("Erreur fetchById:",t),null}finally{n.value=!1}},create:async a=>{n.value=!0,l.value=null;try{const r=await w.create(a);return e.value.unshift(r),t.value.unshift(r),{success:!0,signalement:r}}catch(r){const e=r.message||"Erreur lors de la création du signalement";return l.value=e,console.error("Erreur create:",r),{success:!1,message:e}}finally{n.value=!1}},deleteSignalement:async a=>{n.value=!0,l.value=null;try{return await w.delete(a),e.value=e.value.filter(e=>e.id!==a),t.value=t.value.filter(e=>e.id!==a),{success:!0}}catch(r){const e=r.message||"Erreur lors de la suppression";return l.value=e,{success:!1,message:e}}finally{n.value=!1}},fetchRecap:async()=>{try{r.value=await w.getRecap()}catch(e){console.error("Erreur fetchRecap:",e)}},clearError:()=>{l.value=null},clearSelected:()=>{a.value=null}}}))}}})}();
