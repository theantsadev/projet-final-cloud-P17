var B=Object.defineProperty;var I=(o,e,t)=>e in o?B(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var w=(o,e,t)=>I(o,typeof e!="symbol"?e+"":e,t);import{aA as A,aB as p,aC as i,aD as U,aE as R,aF as y,aG as O,aH as f,aI as D,aJ as g,aK as L,aL as C,aM as b,aN as h,aO as T,H as u,V as S}from"./index-BXUmX6Np.js";const z={NID_DE_POULE:"Nid de poule",FISSURE:"Fissure",INONDATION:"Inondation",OBSTACLE:"Obstacle",ECLAIRAGE:"Éclairage",SIGNALISATION:"Signalisation",AUTRE:"Autre"},K={NOUVEAU:"Nouveau",EN_COURS:"En cours",RESOLU:"Résolu",REJETE:"Rejeté"},k={BASSE:"Basse",NORMALE:"Normale",HAUTE:"Haute",URGENTE:"Urgente"},Q={NOUVEAU:"primary",EN_COURS:"warning",RESOLU:"success",REJETE:"danger"};function v(o,e){return{id:o,titre:e.titre||"",description:e.description||"",typeProbleme:e.typeProbleme||"AUTRE",latitude:e.latitude||0,longitude:e.longitude||0,adresse:e.adresse||"",photoUrl:e.photoUrl,statut:e.statut||"NOUVEAU",priorite:e.priorite||"NORMALE",dateSignalement:e.dateSignalement instanceof h?e.dateSignalement.toDate():new Date(e.dateSignalement||Date.now()),dateResolution:e.dateResolution instanceof h?e.dateResolution.toDate():e.dateResolution?new Date(e.dateResolution):void 0,commentaireResolution:e.commentaireResolution,createdById:e.createdById||"",createdByName:e.createdByName||"",createdByEmail:e.createdByEmail||"",createdAt:e.createdAt instanceof h?e.createdAt.toDate():new Date(e.createdAt||Date.now()),updatedAt:e.updatedAt instanceof h?e.updatedAt.toDate():new Date(e.updatedAt||Date.now())}}class M{constructor(){w(this,"collectionName","signalements")}async getAll(){try{const e=A(p(i,this.collectionName),U("dateSignalement","desc"));return(await R(e)).docs.map(r=>v(r.id,r.data()))}catch(e){throw console.error("Erreur getAll signalements:",e),e}}async getMesSignalements(){const e=y.getCurrentUserId();if(!e)throw new Error("Utilisateur non connecté");try{const t=A(p(i,this.collectionName),O("createdById","==",e),U("dateSignalement","desc"));return(await R(t)).docs.map(s=>v(s.id,s.data()))}catch(t){throw console.error("Erreur getMesSignalements:",t),t}}async getById(e){try{const t=f(i,this.collectionName,e),r=await D(t);return r.exists()?v(r.id,r.data()):null}catch(t){throw console.error("Erreur getById:",t),t}}async create(e){const t=y.getCurrentUser();if(!t)throw new Error("Utilisateur non connecté");try{const r={titre:e.titre,description:e.description||"",typeProbleme:e.typeProbleme,latitude:e.latitude,longitude:e.longitude,adresse:e.adresse||"",photoUrl:e.photoUrl||null,statut:"NOUVEAU",priorite:e.priorite||"NORMALE",dateSignalement:g(),createdById:t.id,createdByName:t.fullName,createdByEmail:t.email,createdAt:g(),updatedAt:g()};return{id:(await L(p(i,this.collectionName),r)).id,titre:e.titre,description:e.description||"",typeProbleme:e.typeProbleme,latitude:e.latitude,longitude:e.longitude,adresse:e.adresse||"",photoUrl:e.photoUrl,statut:"NOUVEAU",priorite:e.priorite||"NORMALE",dateSignalement:new Date,createdById:t.id,createdByName:t.fullName,createdByEmail:t.email,createdAt:new Date,updatedAt:new Date}}catch(r){throw console.error("Erreur create signalement:",r),r}}async delete(e){const t=y.getCurrentUserId();if(!t)throw new Error("Utilisateur non connecté");try{const r=await this.getById(e);if(!r)throw new Error("Signalement non trouvé");if(r.createdById!==t)throw new Error("Vous ne pouvez supprimer que vos propres signalements");await C(f(i,this.collectionName,e))}catch(r){throw console.error("Erreur delete signalement:",r),r}}async update(e,t){try{const r=f(i,this.collectionName,e);await b(r,{...t,updatedAt:g()})}catch(r){throw console.error("Erreur update signalement:",r),r}}async getRecap(){try{const e=await this.getAll(),t=e.length,r=e.filter(c=>c.statut==="NOUVEAU").length,s=e.filter(c=>c.statut==="EN_COURS").length,l=e.filter(c=>c.statut==="RESOLU").length,E=t>0?Math.round(l/t*100):0;return{total:t,nouveaux:r,enCours:s,resolus:l,pourcentageResolus:E}}catch(e){throw console.error("Erreur getRecap:",e),e}}}const d=new M,W=T("signalement",()=>{const o=u([]),e=u([]),t=u(null),r=u(null),s=u(!1),l=u(null),E=S(()=>o.value.length),c=S(()=>e.value.length),N=S(()=>{const n={NOUVEAU:[],EN_COURS:[],RESOLU:[],REJETE:[]};return o.value.forEach(a=>{n[a.statut]&&n[a.statut].push(a)}),n});return{signalements:o,mesSignalements:e,selectedSignalement:t,recap:r,isLoading:s,error:l,signalementCount:E,mesSignalementsCount:c,signalementsByStatut:N,fetchAll:async()=>{s.value=!0,l.value=null;try{o.value=await d.getAll()}catch(n){l.value=n.message||"Erreur lors du chargement des signalements",console.error("Erreur fetchAll:",n)}finally{s.value=!1}},fetchMesSignalements:async()=>{s.value=!0,l.value=null;try{e.value=await d.getMesSignalements()}catch(n){l.value=n.message||"Erreur lors du chargement de vos signalements",console.error("Erreur fetchMesSignalements:",n)}finally{s.value=!1}},fetchById:async n=>{s.value=!0,l.value=null;try{return t.value=await d.getById(n),t.value}catch(a){return l.value=a.message||"Signalement non trouvé",console.error("Erreur fetchById:",a),null}finally{s.value=!1}},create:async n=>{s.value=!0,l.value=null;try{const a=await d.create(n);return o.value.unshift(a),e.value.unshift(a),{success:!0,signalement:a}}catch(a){const m=a.message||"Erreur lors de la création du signalement";return l.value=m,console.error("Erreur create:",a),{success:!1,message:m}}finally{s.value=!1}},deleteSignalement:async n=>{s.value=!0,l.value=null;try{return await d.delete(n),o.value=o.value.filter(a=>a.id!==n),e.value=e.value.filter(a=>a.id!==n),{success:!0}}catch(a){const m=a.message||"Erreur lors de la suppression";return l.value=m,{success:!1,message:m}}finally{s.value=!1}},fetchRecap:async()=>{try{r.value=await d.getRecap()}catch(n){console.error("Erreur fetchRecap:",n)}},clearError:()=>{l.value=null},clearSelected:()=>{t.value=null}}});export{K as a,k as p,Q as s,z as t,W as u};
